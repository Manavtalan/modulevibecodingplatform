# Module Preview Architecture

## Overview
Module's preview system renders AI-generated React components in a stable, sandboxed environment using Sandpack.

## Core Principles

### 1. Fixed Template (NEVER Generated by AI)
Location: `template/base-vite-react-tailwind/`

Fixed files (embedded in `previewAdapter.ts`):
- `index.html` - HTML entry point
- `package.json` - Dependencies manifest
- `tsconfig.json` - TypeScript configuration
- `vite.config.ts` - Vite bundler config
- `postcss.config.cjs` - PostCSS config
- `tailwind.config.cjs` - Tailwind CSS config
- `src/main.tsx` - React entry point
- `src/index.css` - Global styles with Tailwind directives

### 2. AI Files (ONLY These Can Be Generated)
- `src/App.tsx` - Main app component (overrides template placeholder)
- `src/components/*.tsx` - UI components

### 3. Fixed Dependencies (NEVER Dynamic)
```typescript
{
  react: "18.2.0",
  "react-dom": "18.2.0",
  tailwindcss: "3.4.1",
  autoprefixer: "10.4.16",
  postcss: "8.4.31"
}
```

## Data Flow

```
User Prompt
    ↓
Edge Function (generate-code)
    ↓
AI Model (returns JSON with src/App.tsx + src/components/*)
    ↓
Backend Validation (basic checks)
    ↓
Frontend receives GenFile[]
    ↓
usePreviewFiles (debouncing + device state)
    ↓
SandpackPreview component
    ↓
adaptFilesToSandpack
    ├→ validateGeneratedFiles (11+ checks)
    └→ buildSandpackFiles (merge with BASE_TEMPLATE_FILES)
    ↓
Sandpack Render
    ├→ template: "react-ts" (HARDCODED)
    ├→ files: merged file map
    └→ dependencies: FIXED_SANDPACK_DEPS (HARDCODED)
```

## Key Files

### `previewAdapter.ts`
- `BASE_TEMPLATE_FILES` - Embedded fixed template
- `FIXED_SANDPACK_DEPS` - Fixed dependency versions
- `buildSandpackFiles()` - Merges base + AI files
- `adaptFilesToSandpack()` - Validates and prepares files

### `validateGeneratedFiles.ts`
Validation checks (runs BEFORE merge):
1. ✓ Must have `src/App.tsx`
2. ✓ Content must be string
3. ✓ No undefined/null placeholders
4. ✓ No markdown code fences
5. ✓ File size limits (<200KB)
6. ✓ JSX balance (rough `<div>` matching)
7. ✓ No forbidden imports (lucide-react, shadcn, etc.)
8. ✓ No empty imports
9. ✓ Import/export statements present
10. ✓ Brace balance
11. ✓ Component structure

### `SandpackPreview.tsx`
- Receives debounced `GenFile[]`
- Calls `adaptFilesToSandpack()`
- Renders Sandpack with FIXED template and deps
- Shows friendly errors on validation failure

### `usePreviewFiles.ts`
- Debounces file changes (500ms)
- Manages device mode (desktop/tablet/mobile)
- Persists device preference per project
- Provides reload trigger

## Error Handling

### Backend Errors
- Invalid JSON from AI model
- Missing `src/App.tsx`
- Forbidden imports detected

→ Returns error response to frontend

### Frontend Errors
- Validation failure (any of 11+ checks)
- Empty file list
- Adapter error

→ Displays friendly error card with suggestions

### Sandpack Never Receives
- Broken code
- Invalid imports
- Malformed files
- Dynamic dependencies
- AI-generated configs

## Why This Architecture?

### Problem (Before)
- AI sometimes generated broken configs
- Dependencies parsed incorrectly
- Preview crashed on invalid code
- Sandpack errors: "Cannot read null.match"
- Inconsistent styling/behavior

### Solution (Now)
- **Fixed template** = consistent base
- **Strict validation** = broken code caught early
- **Fixed dependencies** = no parsing errors
- **AI only touches UI** = configs never break
- **Graceful errors** = helpful user feedback

## Testing the Preview

### Valid Input
```typescript
{
  "src/App.tsx": "export default function App() { return <div>Hello</div>; }",
  "src/components/Hero.tsx": "export default function Hero() { ... }"
}
```
→ Preview renders successfully

### Invalid Input
```typescript
{
  "src/App.tsx": "import { Icon } from 'lucide-react'; ..."
}
```
→ Validation fails: "Forbidden import detected"
→ Shows error card with suggestions

## Maintenance

### To Update Base Template
1. Modify `BASE_TEMPLATE_FILES` in `previewAdapter.ts`
2. Test with various AI-generated components
3. Never let AI generate these files

### To Update Dependencies
1. Update `FIXED_SANDPACK_DEPS` in `previewAdapter.ts`
2. Update `BASE_TEMPLATE_FILES` package.json to match
3. Test preview rendering

### To Add Validation
1. Add check to `validateGeneratedFiles.ts`
2. Return `{ ok: false, error: "..." }` on failure
3. Test with invalid code samples

## Security Notes

- No user code executes on server
- Sandpack runs in isolated iframe
- No network access from preview
- No localStorage/cookies access
- Fixed dependencies = no supply chain attacks
